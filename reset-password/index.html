<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Reset Password â€“ BookitGY</title>
    <meta name="description" content="Reset your BookitGY password." />
    <style>
      :root { --green:#16a34a; --bg:#0b0f0c; --card:#0f1711; --text:#e7f2ea; --muted:#b7c7bc; --danger:#ef4444; }
      body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:linear-gradient(160deg,#06110a,var(--bg)); color:var(--text); }
      .wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; padding: 32px 20px; }
      .card { width:100%; max-width: 520px; background: rgba(15,23,17,.85); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding: 28px; box-shadow: 0 12px 30px rgba(0,0,0,.35); }
      .brand { display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:0.4px; margin-bottom:18px; }
      .dot { width:12px; height:12px; border-radius:999px; background:var(--green); box-shadow:0 0 22px rgba(22,163,74,.55); }
      h1 { margin: 0 0 8px; font-size: 28px; }
      p { margin: 0 0 12px; color: var(--muted); line-height:1.5; }
      label { display:block; font-size: 13px; color: var(--muted); margin: 14px 0 6px; }
      input { width:100%; padding: 12px 14px; border-radius: 12px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color: var(--text); font-size: 15px; }
      input:focus { outline: 2px solid rgba(22,163,74,.5); border-color: rgba(22,163,74,.6); }
      .btn { width:100%; margin-top:18px; padding: 12px 16px; border-radius: 12px; border:none; font-weight:700; cursor:pointer; background: var(--green); color: #041308; }
      .helper { font-size: 12px; color: var(--muted); margin-top:8px; }
      .status { margin-top: 16px; padding: 12px 14px; border-radius: 12px; font-size: 14px; }
      .status.error { background: rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.35); color: #fecaca; }
      .status.success { background: rgba(22,163,74,.12); border:1px solid rgba(22,163,74,.35); color: #bbf7d0; }
      .link { color: var(--text); text-decoration:none; }
      .link:hover { text-decoration:underline; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="brand"><span class="dot"></span> BookitGY</div>
        <h1>Reset your password</h1>
        <p>Enter a new password below to finish resetting your BookitGY account.</p>

        <form id="reset-form">
          <label for="new-password">New password</label>
          <input id="new-password" name="new-password" type="password" autocomplete="new-password" required />

          <label for="confirm-password">Confirm new password</label>
          <input id="confirm-password" name="confirm-password" type="password" autocomplete="new-password" required />

          <div class="helper">
            Passwords must be at least 5 characters and include at least one uppercase and one lowercase letter.
          </div>

          <button class="btn" type="submit">Reset password</button>
        </form>

        <div id="status" class="status" style="display:none"></div>
      </div>
    </div>

    <script type="module">
      const form = document.getElementById("reset-form");
      const statusEl = document.getElementById("status");
      const urlParams = new URLSearchParams(window.location.search);
      const token = urlParams.get("token");

      const passwordRules = {
        length: /^.{5,}$/,
        uppercase: /[A-Z]/,
        lowercase: /[a-z]/,
      };

      const setStatus = (message, type) => {
        statusEl.textContent = message;
        statusEl.className = `status ${type}`;
        statusEl.style.display = "block";
      };

      const matchesRules = (value) => {
        return (
          passwordRules.length.test(value) &&
          passwordRules.uppercase.test(value) &&
          passwordRules.lowercase.test(value)
        );
      };


      const apiBaseUrl =
        import.meta.env?.VITE_API_BASE_URL ||
        window.API_BASE_URL ||
        "https://bookitgy.onrender.com";
      const resetEndpointPath = "/auth/reset-password";

      const buildApiUrl = (path) => {
        if (!apiBaseUrl) {
          return path;
        }
        return `${apiBaseUrl.replace(/\/$/, "")}${path}`;
      };

      const isDevMode = ["localhost", "127.0.0.1"].includes(window.location.hostname);

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        statusEl.style.display = "none";

        if (!token) {
          setStatus("This reset link is missing a token. Please request a new password reset.", "error");
          return;
        }

        const newPassword = document.getElementById("new-password").value;
        const confirmPassword = document.getElementById("confirm-password").value;

        // Client-side validation for password match and rules.
        if (newPassword !== confirmPassword) {
          setStatus("Passwords do not match. Please try again.", "error");
          return;
        }

        if (!matchesRules(newPassword)) {
          setStatus("Password does not meet the required rules.", "error");
          return;
        }

        try {
          const requestUrl = buildApiUrl(resetEndpointPath);

          if (isDevMode) {
            console.info("Reset password request URL:", requestUrl);
          }

          const response = await fetch(requestUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, new_password: newPassword }),
          });

          if (response.ok) {
            setStatus("Password reset successful. You can now log in.", "success");
            statusEl.innerHTML = `Password reset successful. <a class="link" href="/login">Go to login</a>.`;
            form.reset();
            return;
          }

          if (response.status === 404) {
            setStatus("Password reset service unavailable.", "error");
            return;
          }

          const payload = await response.json().catch(() => ({}));
          const tokenErrorStatuses = [400, 401, 422];

          if (tokenErrorStatuses.includes(response.status)) {
            setStatus("This reset link is invalid or expired. Please request a new password reset.", "error");
            return;
          }

          setStatus("We couldn't reset your password right now. Please try again later.", "error");
        } catch (error) {
          // Network or unexpected errors.
          setStatus("We couldn't reset your password right now. Please try again later.", "error");
        }
      });
    </script>
  </body>
</html>
